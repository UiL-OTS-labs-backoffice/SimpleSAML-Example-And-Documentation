<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
    <meta charset="utf-8"/><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Python guide &mdash; CDH Federated Authentication  documentation</title>
            <link rel="stylesheet" href="../_static/pygments.css" type="text/css"/>
            <link rel="stylesheet" href="../_static/theme.css" type="text/css"/>
        <script src="../_static/bootstrap.bundle.min.js"></script>
            
                    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
                    <script src="../_static/doctools.js"></script>
                    <script src="../_static/sphinx_highlight.js"></script>
            <script src="../_static/js/theme.js"></script>
            <link rel="index" title="Index" href="../genindex.html"/>
            <link rel="search" title="Search" href="../search.html"/>
            <link rel="next" title="Django guide" href="django.html"/>
            <link rel="prev" title="PHP Guide" href="php.html"/> 
    <style>
        .navbar .caption {
            display: none;
        }
    </style>
</head>

<body>

<div class="uu-root-container">
    <div class="uu-header">
        <div class="uu-header-row">
            <div class="uu-logo">
                <img src="../_static/logo-header-en.svg">
            </div>
            <div class="fs-3 ms-5 text-black">
                CDH Federated Authentication  documentation
            </div>
            <div class="border-left ms-auto">
                <div role="search" class="ms-auto">
                  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
                    <input type="text" class="form-control" name="q" placeholder="Search docs" />
                    <input type="hidden" name="check_keywords" value="yes" />
                    <input type="hidden" name="area" value="default" />
                  </form>
                </div>
            </div>
        </div>
    </div>
        <nav class="navbar uu-navbar">
            <div class="uu-navbar-container">
                <a href="https://www.uu.nl" class="navbar-brand">
                    <img src="../_static/logo-header-en.svg">
                </a>
                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbar-content"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
                >
                    <span class="navbar-toggler-icon" />
                </button>
                <div id="navbar-content" class="collapse navbar-collapse">
                        <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../general/index.html">General information</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">SAML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developmentidp/index.html">Development IdP</a></li>
</ul>

                </div>
            </div>
        </nav>
    <div class="uu-content">
        <div class="uu-hero"><ol class="breadcrumb mb-0">
    <li class="breadcrumb-item">
        <a href="../index.html">
            CDH Federated Authentication
        </a>
    </li>
    <li class="breadcrumb-item">
        <a href="index.html"
           
               accesskey="U"
               class="active"
           >
           SAML
        </a>
    </li>
    <li class="breadcrumb-item active">Python guide</li>
</ol></div> 
                <div class="uu-container">
                    <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                            <div itemprop="articleBody">
                                
  <section id="python-guide">
<h1>Python guide<a class="headerlink" href="#python-guide" title="Permalink to this heading">¶</a></h1>
<p>These instructions try to follow the installation guide of Python3-SAML provided
in <a class="reference external" href="https://github.com/SAML-Toolkits/python3-saml">the readme of the package</a>,
but tries to help configuring the service provider exactly to the needs of ITS’
Identity Provider</p>
<p>Do note that even for Python various implementations of SAML exist. E.g. PySAML2.
A library worth especially worth mentioning is Django SAML2 Auth, a library
integrating the Service Provider into Django with minimal configuration
required. Whether this implementation works with the IdP configuration
maintained by ITS is, however, not verified, but if your current application
uses Django authentication, this library might be worthwhile to explore.</p>
<p>The reason OneLogin’s Python-SAML library is elaborated here is that it is a
Python-general library that can be used in any Python framework, it is well
documented and OneLogin has implementations for many other languages that follow
roughly the same procedures. The last of these arguments means that if this
how-to is successful, it can more easily be generalized to implementations for
other languages than is the case with other libraries.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The CDH is currently migrating to our own <a class="reference internal" href="django.html"><span class="doc">Django auth app</span></a>
that uses PySAML2 for SAML. As a result, this guide might be out-of-date.</p>
</div>
<nav class="contents local" id="table-of-contents">
<p class="topic-title"><strong>Table of Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#library-setup" id="id1">Library Setup</a></p></li>
<li><p><a class="reference internal" href="#preparing-your-application" id="id2">Preparing your application</a></p>
<ul>
<li><p><a class="reference internal" href="#setting-up-the-auth-object" id="id3">Setting up the auth object</a></p></li>
<li><p><a class="reference internal" href="#creating-a-metadata-page" id="id4">Creating a Metadata page</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#contact-its" id="id5">Contact ITS</a></p></li>
<li><p><a class="reference internal" href="#using-saml-auth-in-your-project" id="id6">Using SAML auth in your project</a></p>
<ul>
<li><p><a class="reference internal" href="#authenticate-users-in-your-python-application" id="id7">Authenticate users in your Python application</a></p></li>
<li><p><a class="reference internal" href="#process-the-authentication-response" id="id8">Process the authentication response</a></p></li>
<li><p><a class="reference internal" href="#checking-if-the-user-is-logged-in" id="id9">Checking if the user is logged in</a></p></li>
<li><p><a class="reference internal" href="#logout-the-user" id="id10">Logout the user</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="library-setup">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Library Setup</a><a class="headerlink" href="#library-setup" title="Permalink to this heading">¶</a></h2>
<p>In this tutorial, the name <code class="docutils literal notranslate"><span class="pre">hostname</span></code> will be used for the base URL of the web
application. The name <code class="docutils literal notranslate"><span class="pre">saml_location</span></code> will be used for the absolute path saml
is installed in. The name <code class="docutils literal notranslate"><span class="pre">saml_url</span></code> will be used for the url path to the saml
service provider (as <code class="docutils literal notranslate"><span class="pre">hostname/saml_url</span></code>).</p>
<ol class="arabic">
<li><p>Depending on which configuration you use, any of these packages may be
required:</p>
<ul class="simple">
<li><p>Linux packages:</p>
<ul>
<li><p>libxml2</p></li>
<li><p>libxml2-dev</p></li>
<li><p>libxlst1-dev</p></li>
<li><p>python-dev</p></li>
<li><p>pkg-config</p></li>
<li><p>libxmlsec1-dev</p></li>
</ul>
</li>
<li><p>Pip packages:</p>
<ul>
<li><p>xmlsec</p></li>
<li><p>isodate</p></li>
<li><p>defusedxml</p></li>
</ul>
</li>
</ul>
<p>If you already use Django or a similar framework, you will most likely
already have these packages installed</p>
</li>
<li><p>Installing OneLogin Saml-3 is as simple as running a pip command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>python3-saml
</pre></div>
</div>
<p>You may also simply add python3-saml to your dependencies if you are using
dependancy management.</p>
</li>
<li><p>Inside your project, create a folder named <code class="docutils literal notranslate"><span class="pre">saml</span></code>. Within this folder, you
need to create two files, <code class="docutils literal notranslate"><span class="pre">settings.json</span></code> and <code class="docutils literal notranslate"><span class="pre">advanced_settings.json</span></code>,
and one directory: <code class="docutils literal notranslate"><span class="pre">certs</span></code>.</p></li>
<li><p>Open the file <code class="docutils literal notranslate"><span class="pre">settings.json</span></code> you just created for editing. In the readme
of the python3-saml repository you can find complete specifications for all
options in this file. However, you can use the following template as a
minimal configuration. These options are at the very least required:</p>
<p>TODO: this is not the entire file?</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;strict&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;debug&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sp&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;entityId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://&lt;hostname&gt;/saml/metadata/&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;assertionConsumerService&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://&lt;hostname&gt;/saml/acs/&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;binding&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;singleLogoutService&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://&lt;hostname&gt;/saml/sls/&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;binding&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;NameIDFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;attributeConsumingService&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;idp&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;entityId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://login.uu.nl/nidp/saml2/metadata&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;singleSignOnService&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://login.uu.nl/nidp/saml2/sso&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;binding&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;singleLogoutService&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://login.uu.nl/nidp/saml2/slo&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;binding&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;x509cert&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ol class="arabic">
<li><p>Replace all occurences of <code class="docutils literal notranslate"><span class="pre">&lt;hostname&gt;</span></code> with the hostname of your web
application</p></li>
<li><p>These settings are for the production IdP. To use the acceptation IdP,
change <code class="docutils literal notranslate"><span class="pre">login.uu.nl</span></code> to <code class="docutils literal notranslate"><span class="pre">login.acc.uu.nl</span></code>.</p></li>
<li><p>Optionally, change the value of <code class="docutils literal notranslate"><span class="pre">serviceName</span></code> and <code class="docutils literal notranslate"><span class="pre">serviceDescription</span></code>
to a name and description of your liking. The name should not contain any
spaces and should be as simple as possible. After you have requested
access to the IdP from ITS, changing this value will cause SAML to stop
working.</p></li>
<li><div class="line-block">
<div class="line">If you already have the public key of the IdP you register on (either
their acceptation IdP or their production IdP) you can add the contents
to the value of <code class="docutils literal notranslate"><span class="pre">idp.x509cert</span></code>.</div>
<div class="line"><br /></div>
<div class="line">If you do not have this yet, contact ITS to ask for it, or go to
<a class="reference external" href="https://login.uu.nl/nidp/saml2/metadata">https://login.uu.nl/nidp/saml2/metadata</a> and use the value of
<code class="docutils literal notranslate"><span class="pre">ds:X509Certificate</span></code> in the node <code class="docutils literal notranslate"><span class="pre">ds:KeyInfo</span></code>. You will have to
remove the line endings before adding the contents of this key to your
json file</div>
<div class="line"><br /></div>
<div class="line">If that is unclear, you can always e-mail ITS and ask for the public key
for their IdP (mention if you want the acceptation IdP or the production
IdP)</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Optionally, you might want to use persistent <code class="docutils literal notranslate"><span class="pre">NameID</span></code>’s instead of
transient ones. To do this, chance <code class="docutils literal notranslate"><span class="pre">sp.NameIDFormat</span></code> to
<code class="docutils literal notranslate"><span class="pre">urn:oasis:names:tc:SAML:2.0:nameid-format:persistant</span></code></div>
<div class="line">If you don’t know what this means, leave it on transient for now. You
can always change this later</div>
</div>
</li>
</ol>
</li>
<li><p>Open the file <code class="docutils literal notranslate"><span class="pre">advanced_settings.json</span></code> you just created. You can insert
the following template:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;security&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;nameIdEncrypted&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;authnRequestsSigned&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;logoutRequestSigned&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;logoutResponseSigned&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;signMetadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;wantMessagesSigned&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;wantAssertionsSigned&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;wantNameId&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;wantNameIdEncrypted&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;wantAssertionsEncrypted&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;signatureAlgorithm&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://www.w3.org/2000/09/xmldsig#rsa-sha256&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;metadataValidUntil&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2027-03-06T09:00:30Z&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;requestedAuthnContext&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;contactPerson&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;technical&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;givenName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;technical_name&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;emailAddress&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;technical@example.com&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;support&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;givenName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;support_name&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;emailAddress&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;support@example.com&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;organization&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;en-US&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default-sp&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;displayname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default-sp&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://&lt;hostname&gt;/saml&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Replace all occurences of <code class="docutils literal notranslate"><span class="pre">&lt;hostname&gt;</span></code> with the host name of your web
application</p></li>
<li><p>Replace all values in <code class="docutils literal notranslate"><span class="pre">ContactPerson</span></code> and <code class="docutils literal notranslate"><span class="pre">organization</span></code> to your own
needs</p></li>
</ol>
</li>
<li><div class="line-block">
<div class="line">Inside the <code class="docutils literal notranslate"><span class="pre">saml/certs</span></code> folder you created earlier, there should the
public and private components of a key that SAML can use to sign requests.</div>
<div class="line"><br /></div>
<div class="line">You must use keys following the X.509 standard (e.g. your SSL certificate),
provided by an UU approved CA. Make sure to cal them <code class="docutils literal notranslate"><span class="pre">sp.key</span></code> and
<code class="docutils literal notranslate"><span class="pre">sp.cert</span></code> respectively.</div>
</div>
<ul class="simple">
<li><p>See also <a class="reference internal" href="certificates.html"><span class="doc">Generating self-signed certificates</span></a></p></li>
</ul>
</li>
</ol>
</section>
<section id="preparing-your-application">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Preparing your application</a><a class="headerlink" href="#preparing-your-application" title="Permalink to this heading">¶</a></h2>
<p>To start using SAML in your application, you have to load the various classes.
Where you do this depends on the framework you use. Minimal demos are provided
by OneLogin for the Django, Flask and Pyramid frameworks. The following section
largely uses examples from the django demo, but tries to elaborate a bit more on
what to implement and why. The code may have been adapted to fully work with
the ITS IdP.</p>
<section id="setting-up-the-auth-object">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Setting up the auth object</a><a class="headerlink" href="#setting-up-the-auth-object" title="Permalink to this heading">¶</a></h3>
<p>Python-SAML works largely from a singly object that you need in your code: the
auth object. This object is constructed from a request (from Django, Flask,
Pyramid, etc) and can be used to process the response sent by the IdP,
authenticate users and extract attributes of the signed in user.</p>
<p>In order to use Python-SAML in your project, you need to load the appropriate
libraries:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">onelogin.saml2.auth</span> <span class="kn">import</span> <span class="n">OneLogin_Saml2_Auth</span>
<span class="kn">from</span> <span class="nn">onelogin.saml2.settings</span> <span class="kn">import</span> <span class="n">OneLogin_Saml2_Settings</span>
<span class="kn">from</span> <span class="nn">onelogin.saml2.utils</span> <span class="kn">import</span> <span class="n">OneLogin_Saml2_Utils</span>
</pre></div>
</div>
<p>Once these libraries are loaded, the auth object can be constructed. This
object takes two parameters: A dictionary containing request information and
the full path to your saml settings directory. The latter is the location
where you placed your certs directory and your .json files. The former has
the following general form:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">req</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;http_host&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;script_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;server_port&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_data&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;post_data&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>All these parameters are about your server. So <code class="docutils literal notranslate"><span class="pre">http_host</span></code> is your server
address (in previous section indicated as <code class="docutils literal notranslate"><span class="pre">hostname</span></code>), <code class="docutils literal notranslate"><span class="pre">script_name</span></code> is the
path to the specific script being executed (or page being loaded) and
<code class="docutils literal notranslate"><span class="pre">server_port</span></code> is the port through which your server can be accessed. If you
are using an SSL connection, this will most likely be 443.</p>
<p>In most frameworks, this dictionary can be extracted from the framework itself.</p>
<p>The auth object can be created like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span> <span class="o">=</span> <span class="n">OneLogin_Saml2_Auth</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">custom_base_path</span><span class="o">=</span><span class="s1">&#39;/path/to/saml/configuration/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You will need this auth object on any page you want to use SAML features on,
so you might want to create a function that will generate this object
automatically from the request object of your framework. The rest of this
documentation will assume a function called <code class="docutils literal notranslate"><span class="pre">init_saml_auth(req)</span></code>, which
creates the auth object from the req dictionary as indicated above.</p>
</section>
<section id="creating-a-metadata-page">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Creating a Metadata page</a><a class="headerlink" href="#creating-a-metadata-page" title="Permalink to this heading">¶</a></h3>
<p>In order to have ITS add your Service Provider (SP) to their Identity Provider
(IdP), they will need an overview of your metadata. This metadata is
automatically generated by Python-SAML using the following code
(although there are various other ways of doing this as well):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span> <span class="o">=</span> <span class="n">init_saml_auth</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="n">saml_settings</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">saml_settings</span><span class="o">.</span><span class="n">get_sp_metadata</span><span class="p">()</span>
<span class="n">errors</span> <span class="o">=</span> <span class="n">saml_settings</span><span class="o">.</span><span class="n">validate_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error found on Metadata: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)))</span>
</pre></div>
</div>
<p>An XML version of this output should be located at the address set for the
<code class="docutils literal notranslate"><span class="pre">entityID</span></code> which you set in the <code class="docutils literal notranslate"><span class="pre">settings.json</span></code> file. In the example,
this was <code class="docutils literal notranslate"><span class="pre">https://hostname/saml/metadata/</span></code></p>
</section>
</section>
<section id="contact-its">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Contact ITS</a><a class="headerlink" href="#contact-its" title="Permalink to this heading">¶</a></h2>
<p>You should now contact ITS and ask them to add your Service Provider to their
Identity Provider. Save the metadata as an XML file and send this file to ITS,
along with the message that you want to register your application with their
Identity Provider. Give the base URL of your application and say if you want to
make use of their acceptation or production Identity Provider
(depending on what URL you entered in <code class="docutils literal notranslate"><span class="pre">settings.json</span></code> file).</p>
<p>Also indicate which fields you want the Identity Provider to pass back with a
successful authentication redirect (such as solis-ID, full name, e-mail address,
etc).</p>
<p>Once they have added you, you should be able to use SAML for authenticating your
users.</p>
</section>
<section id="using-saml-auth-in-your-project">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Using SAML auth in your project</a><a class="headerlink" href="#using-saml-auth-in-your-project" title="Permalink to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We are loosely basing the following examples on Django,
but you should take note of your framework’s auth tools/code/backend on how
to actually implement this in your app. (Note: loosely means loosely, it’s
not valid Django code either)</p>
</div>
<section id="authenticate-users-in-your-python-application">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Authenticate users in your Python application</a><a class="headerlink" href="#authenticate-users-in-your-python-application" title="Permalink to this heading">¶</a></h3>
<p>To authenticate users, you have to send an <em>authentication request</em> to the
single sign on (SSO) service of the IdP. You have already configured everything
Python-SAML needs in the <code class="docutils literal notranslate"><span class="pre">settings.json</span></code> file, so the URL to send this request
to can be generated from the <code class="docutils literal notranslate"><span class="pre">login()</span></code> function of the auth object. Lets say
the user should be authenticated right away when they visit the index page of
your site. The code could look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">init_saml_auth</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>

    <span class="c1"># Redirect the user to this url (exact method depends on framework)</span>
    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
<p>This code will redirect the user to the SAML login page configured in the IdP.
If the user logs in succesfully, she will be redirected back to the
Attribute Customer Service (ACS) of your service provider, where the
authentication can be processed. This last redirect makes use of the
POST method. The important information is encoded as POST data.</p>
<p>If you want the user to end up on a different page than your ACS page after they
have authenticated, you can add the return_to parameter to the login function
(in this example in your index function):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">target_url</span> <span class="o">=</span> <span class="s1">&#39;where-you-want-to-send-the-user.example.org&#39;</span>
<span class="n">auth</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">return_to</span><span class="o">=</span><span class="n">target_url</span><span class="p">)</span>
</pre></div>
</div>
<p>Along with the return_to parameter, the login method accepts three other names
parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">force_authn</span></code>: If set to True, the user will be forced to enter their
credentials. Usually this is not required if the user is already signed in to
the IdP, either on this application or on another application in the same
browser.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_passive</span></code>: This is the opposite of force_authn; if the user is already
logged in to the IdP, the user will not have to enter their credentials, even
if they did not yet log in to this specific application (Possibly not supported
by the ITS IdP)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">set_nameid_policy</span></code>: If set to true, the name ID policy will be added to the
login request sent to the IdP. For the current configuration of the ITS IdP
this does not add anything useful.</p></li>
</ul>
</section>
<section id="process-the-authentication-response">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Process the authentication response</a><a class="headerlink" href="#process-the-authentication-response" title="Permalink to this heading">¶</a></h3>
<p>The location of your ACS is configured in the settings.json file, but it still
has to be implemented. In the example above, the location of the ACS
is <code class="docutils literal notranslate"><span class="pre">https://hostname/saml/acs/</span></code>, so in this case, the ACS needs to be
implemented on the acs endpoint.</p>
<p>The ACS will process the information sent back by the IdP. Lets create the acs
endpoint:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">acs</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">init_saml_auth</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">auth</span><span class="o">.</span><span class="n">process_response</span><span class="p">()</span> <span class="c1"># This is the magic of checking the IdP response</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_errors</span><span class="p">()</span> <span class="c1"># If something went wrong, we will know</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;Not authenticated&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span> <span class="c1">#this will only work on a response object</span>
            <span class="c1"># So we have to remember if the user already authenticated</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;samlUserdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_attributes</span><span class="p">()</span>
            <span class="c1"># We also need the NameID provided by the IdP in case we want to send a followup request</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;samlNameId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_nameid</span><span class="p">()</span>
            <span class="c1"># And for good measure, let&#39;s save the session index as well</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;samlSessionIndex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_session_index</span><span class="p">()</span>

            <span class="k">if</span> <span class="s1">&#39;RelayState&#39;</span> <span class="ow">in</span> <span class="n">req</span><span class="p">[</span><span class="s1">&#39;post_data&#39;</span><span class="p">]</span> <span class="ow">and</span>
              <span class="n">OneLogin_Saml2_Utils</span><span class="o">.</span><span class="n">get_self_url</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">!=</span> <span class="n">req</span><span class="p">[</span><span class="s1">&#39;post_data&#39;</span><span class="p">][</span><span class="s1">&#39;RelayState&#39;</span><span class="p">]:</span>
                <span class="c1"># If the authentication request was accompanied by a relay state, i.e. an</span>
                <span class="c1"># url to send the user to after authentication, redirect there</span>
                <span class="n">auth</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="s1">&#39;post_data&#39;</span><span class="p">][</span><span class="s1">&#39;RelayState&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;Authentication failed&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; errors: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="c1"># Unless a relay state was given</span>
</pre></div>
</div>
<p>Notice the function call <code class="docutils literal notranslate"><span class="pre">is_authenticated()</span></code> on the auth object. This call
will only work after <code class="docutils literal notranslate"><span class="pre">process_response()</span></code> is called and an actual response is
available. Because this response is not stateless (i.e. no longer exists after
the user navigates to a different page) this call can not always be made.
To verify the authentication status of the user on later pages, the required
information is stored in the session data.</p>
<p>Notice also that we extract the <code class="docutils literal notranslate"><span class="pre">NameID</span></code> from the response object. This is
because the configuration ITS has set for its IdP requires the <code class="docutils literal notranslate"><span class="pre">NameID</span></code> to be
sent back with every following request. This is especially important if you
want to send a logout request.</p>
<p>Now that the data is stored in the session, you can use it anywhere. The various
demos provided by OneLogin provide a separate page where the authenticated user
can check her own attribute values.</p>
</section>
<section id="checking-if-the-user-is-logged-in">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Checking if the user is logged in</a><a class="headerlink" href="#checking-if-the-user-is-logged-in" title="Permalink to this heading">¶</a></h3>
<p>On any page that does not have direct access to the login response, you can
check if the user is logged in by checking if the key samlUserdata is in your
session data. If you want to verify authentication on other pages in a different
manner, make sure to set this up in the acs.</p>
</section>
<section id="logout-the-user">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Logout the user</a><a class="headerlink" href="#logout-the-user" title="Permalink to this heading">¶</a></h3>
<p>The process for a user to logout of your application consists of two parts,
similar to the login: A logout request is sent to the IdP, and the IdP
response is then processed on your application.</p>
<p>To send a logout request:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">init_saml_auth</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c1"># Start building the logout request</span>
    <span class="n">name_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">session_index</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Both these parameters are required by the ITS IdP!</span>
    <span class="k">if</span> <span class="s1">&#39;samlNameId&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
        <span class="n">name_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;samlNameId&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;samlSessionIndex&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
        <span class="n">session_index</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;samlSessionIndex&#39;</span><span class="p">]</span>

    <span class="n">logouturl</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">logout</span><span class="p">(</span>
        <span class="n">name_id</span><span class="o">=</span><span class="n">name_id</span><span class="p">,</span>
        <span class="n">session_index</span><span class="o">=</span><span class="n">session_index</span><span class="p">,</span>
        <span class="n">return_to</span><span class="o">=</span><span class="s1">&#39;http://logout.uu.nl&#39;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">logouturl</span><span class="p">)</span>
</pre></div>
</div>
<p>When the user navigates to this endpoint, she will be redirected to the IdP
with a logout request. The IdP will process this response and, if successful,
return the user to the Single Logout Service (SLS) endpoint of your SP. In the
<code class="docutils literal notranslate"><span class="pre">settings.json</span></code> file we defined this as <code class="docutils literal notranslate"><span class="pre">https://hostname/saml/sls/</span></code> so in
this case our SLS should be located at the sls endpoint:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sls</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">init_saml_auth</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c1"># create a passable function that flushes the session data.</span>
    <span class="c1"># At least make sure the session values you use to check if</span>
    <span class="c1"># your user is still authenticated are deleted, so when the</span>
    <span class="c1"># user goes back to your page, she has to login again</span>
    <span class="n">dscb</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">process_slo</span><span class="p">(</span><span class="n">delete_session_cb</span><span class="o">=</span><span class="n">dscb</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If the SSO is initiated by the Service Provider, rather</span>
        <span class="c1"># than by the IdP, the process_slo function does not return</span>
        <span class="c1"># a url. In that case, we can extract it automatically from</span>
        <span class="c1"># the auth object (if the login function was called with</span>
        <span class="c1"># a &#39;return_to&#39; parameter)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">()</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_errors</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Succesfully logged out!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Construct a useful error message</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt;Logout failed&lt;/p&gt;&#39;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;ul&gt;&#39;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;li&gt;</span><span class="si">{0}</span><span class="s1">&lt;/li&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/ul&gt;&#39;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;Reason: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">get_last_error_reason</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


                            </div>
                            </div>
                </div>
    </div>

    <footer class="uu-footer">

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Centre for Digital Humanities, Utrecht University.</p>
  </div> 

</footer>
</div>

</body>
</html>